#!/bin/bash
# Sets up the project. Run this script immediately after cloning the repo.

# Path to the project root directory
root="$(git rev-parse --show-toplevel)"

error() {
  echo -e >&2 "Error: $1"
  exit 1
}

plugin_installed() {
  vagrant plugin list | cat | grep -q "$1"
}

install_vagrant_plugin() {
  plugin_installed "$1" || vagrant plugin install "$1"
}

env_file_present() {
  [ -f "$root/ops/$1" ] || error "couldn't find environment file: $1"
}

install_dependencies() {
  composer install --working-dir="$root"
}

seed_database() {
  sh "$root/bin/data_sync" "-i" "-s"
}

install_vagrant_plugin "vagrant-hostsupdater"
install_vagrant_plugin "vagrant-timezone"
install_vagrant_plugin "vagrant-vbguest"
env_file_present ".env"
env_file_present ".env_app"
install_dependencies
seed_database
