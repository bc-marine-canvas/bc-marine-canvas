#!/bin/bash

if [ "$HUGO_BIND_TO_IP" == "true" ] && [ "$HUGO_SERVERLESS" == "true" ]; then
  echo >&2 "â˜ž Not starting the Hugo server because \$HUGO_BIND_TO_IP and" \
    "\$HUGO_SERVERLESS are both set (can't do both simultaneously)"
  exit 1
fi

if [ -n "$HUGO_BIND_TO_IP" ]; then
  bindToIP="$( \
    networksetup -getinfo Wi-Fi \
    | grep "IP address: 1" \
    | cut -d' ' -f3 \
  )"

  if ! grep -q "$bindToIP" /etc/hosts; then
    echo "Missing entries in /etc/hosts:"
    echo
    echo "$bindToIP bcmarinecanvasri.local"
    echo "$bindToIP www.bcmarinecanvasri.local"
    echo

    exit
  fi

  sudo hugo server \
    --disableFastRender \
    --noHTTPCache \
    --printMemoryUsage \
    --printPathWarnings \
    --printUnusedTemplates \
    --templateMetrics \
    --templateMetricsHints \
    --verbose \
    --bind "$bindToIP" \
    --port 80 \
    --appendPort "false" \
    --baseURL "http://www.bcmarinecanvasri.local"
elif [ -n $HUGO_SERVERLESS ]; then
  serverless_command="hugo server
    --disableFastRender
    --noHTTPCache
    --printMemoryUsage
    --printPathWarnings
    --printUnusedTemplates
    --templateMetrics
    --templateMetricsHints
    --verbose"

  netlify dev \
    --targetPort 1313 \
    --command "$(echo $serverless_command)"
else
  hugo server \
    --disableFastRender \
    --noHTTPCache \
    --printMemoryUsage \
    --printPathWarnings \
    --printUnusedTemplates \
    --templateMetrics \
    --templateMetricsHints \
    --verbose
fi
